<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui" />
		<style type="text/css" title="Default">
			/* fullscreen */
			html {
				height:100%;
			}
			body {
				height:100%;
				margin: 0px;
				overflow:hidden; /* disable scrollbars */
			}
			/* fix for scroll bars on webkit & >= Mac OS X Lion */ 
			::-webkit-scrollbar {
				background-color: rgba(0,0,0,0.5);
				width: 0.75em;
				height: 0.75em;
			}
			::-webkit-scrollbar-thumb {
    			background-color:  rgba(255,255,255,0.5);
			}

			/* VR mode button */
			#vr-button {
				position: fixed;
				left: 50%;
				transform: translateX(-50%);
				bottom: 12px;
				z-index: 9999;
				background: rgba(0,0,0,0.6);
				color: #fff;
				border: none;
				padding: 10px 12px;
				border-radius: 6px;
				font-size: 14px;
				cursor: pointer;
			}
		</style>	
		<link href="styles.css" rel="stylesheet">
	</head>
	<body>
	<!-- -----------8<----------- cut here -----------8<----------- --> 
		<script type="text/javascript" src="pano2vr_player.js">
		</script>
		<div id="container" style="width:100%;height:100%;">
		Loading...
		</div>
		<!-- VR mode button -->
		<button id="vr-button" aria-label="Enter VR mode">VR Mode</button>
		<script type="text/javascript">
			// create the panorama player with the container
			pano=new pano2vrPlayer("container");
			// load the configuration
			window.addEventListener("load", function() {
				pano.readConfigUrlAsync("pano.xml");
			});
		</script>
		<!-- three.js for VR sphere rendering -->
		<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
		<script type="text/javascript">
			// VR sphere viewer that re-uses pano2vr's canvas as a dynamic texture
			(function(){
				const vrButton = document.getElementById('vr-button');
				let xrSession = null;
				let renderer, scene, cameraLeft, cameraRight, sphere, texture;
				let animationId;

				function findPanoCanvas(){
					const container = document.getElementById('container');
					// pano2vr may render to a canvas inside the container
					const cvs = container.querySelector('canvas');
					if(cvs) return cvs;
					// try finding any img or video fallback
					const img = container.querySelector('img');
					if(img){
						// draw image to a temporary canvas
						const tmp = document.createElement('canvas');
						tmp.width = img.naturalWidth || 2048;
						tmp.height = img.naturalHeight || 1024;
						const ctx = tmp.getContext('2d');
						ctx.drawImage(img,0,0,tmp.width,tmp.height);
						return tmp;
					}
					return null;
				}

				function createThree(panoCanvas){
					// create renderer and scene
					renderer = new THREE.WebGLRenderer({antialias:true});
					renderer.setPixelRatio(window.devicePixelRatio);
					renderer.setSize(window.innerWidth, window.innerHeight);
					renderer.domElement.style.position = 'fixed';
					renderer.domElement.style.left = '0';
					renderer.domElement.style.top = '0';
					renderer.domElement.style.zIndex = 9998;
					document.body.appendChild(renderer.domElement);

					scene = new THREE.Scene();

					// create inside-out sphere
					const geometry = new THREE.SphereGeometry(500, 60, 40);
					geometry.scale(-1,1,1);

					texture = new THREE.CanvasTexture(panoCanvas);
					texture.needsUpdate = true;
					const material = new THREE.MeshBasicMaterial({map: texture});
					sphere = new THREE.Mesh(geometry, material);
					scene.add(sphere);

					// left / right cameras for stereo fallback
					cameraLeft = new THREE.PerspectiveCamera(75, (window.innerWidth/2)/window.innerHeight, 0.1, 1100);
					cameraRight = new THREE.PerspectiveCamera(75, (window.innerWidth/2)/window.innerHeight, 0.1, 1100);

					window.addEventListener('resize', onWindowResize);
				}

				function onWindowResize(){
					if(!renderer) return;
					renderer.setSize(window.innerWidth, window.innerHeight);
					cameraLeft.aspect = (window.innerWidth/2)/window.innerHeight;
					cameraLeft.updateProjectionMatrix();
					cameraRight.aspect = (window.innerWidth/2)/window.innerHeight;
					cameraRight.updateProjectionMatrix();
				}

				function animateCardboard(panoCanvas){
					texture.needsUpdate = true;
					// small eye separation
					const eyeSeparation = 0.03;
					cameraLeft.position.set(-eyeSeparation,0,0);
					cameraRight.position.set(eyeSeparation,0,0);

					renderer.setScissorTest(true);
					// left
					renderer.setScissor(0,0,window.innerWidth/2,window.innerHeight);
					renderer.setViewport(0,0,window.innerWidth/2,window.innerHeight);
					renderer.render(scene, cameraLeft);
					// right
					renderer.setScissor(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight);
					renderer.setViewport(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight);
					renderer.render(scene, cameraRight);
					renderer.setScissorTest(false);
					animationId = requestAnimationFrame(()=>animateCardboard(panoCanvas));
				}

				async function enterWebXR(panoCanvas){
					if(!navigator.xr) throw new Error('WebXR not available');
					const supported = await navigator.xr.isSessionSupported('immersive-vr');
					if(!supported) throw new Error('immersive-vr not supported');
					xrSession = await navigator.xr.requestSession('immersive-vr');
					renderer.xr.enabled = true;
					renderer.xr.setSession(xrSession);
					// simple render loop using WebXR's animation frame
					renderer.setAnimationLoop(()=>{
						texture.needsUpdate = true;
						renderer.render(scene, cameraLeft); // camera used is controlled by XR
					});
					xrSession.addEventListener('end', ()=>{
						renderer.setAnimationLoop(null);
						renderer.domElement.remove();
						renderer = null;
					});
				}

				async function startVRSphere(){
					const panoCanvas = findPanoCanvas();
					if(!panoCanvas){
						alert('Could not find the panorama canvas. The VR viewer requires the pano to render into a canvas.');
						return;
					}
					// create three if not created
					if(!renderer) createThree(panoCanvas);
					// try WebXR first
					try{
						await enterWebXR(panoCanvas);
						console.log('Entered WebXR');
						return;
					}catch(e){
						console.warn('WebXR start failed or not available:', e);
					}
					// fallback: cardboard side-by-side view
					cancelAnimationFrame(animationId);
					animateCardboard(panoCanvas);
				}

				vrButton.addEventListener('click', startVRSphere);
			})();
		</script>
		<script type="text/javascript">
			(function(){
				const vrButton = document.getElementById('vr-button');
				const container = document.getElementById('container');
				async function enterVR(){
					// Request fullscreen first to maximize compatibility with simple VR viewers
					try{
						if(container.requestFullscreen){
							await container.requestFullscreen();
						}else if(container.webkitRequestFullscreen){
							await container.webkitRequestFullscreen();
						}else if(container.msRequestFullscreen){
							await container.msRequestFullscreen();
						}
					}catch(err){
						console.warn('Fullscreen request failed:', err);
					}
					// Attempt WebXR immersive-vr session when available (best-effort)
					if(navigator.xr && navigator.xr.isSessionSupported){
						try{
							const supported = await navigator.xr.isSessionSupported('immersive-vr');
							if(supported){
								try{
									const session = await navigator.xr.requestSession('immersive-vr');
									console.log('WebXR session started', session);
									// Note: starting a full WebXR presentation typically requires an XR-compatible renderer.
									// We keep the session open so VR-capable browsers/devices can present the page.
									session.addEventListener('end', ()=>{ console.log('XR session ended'); });
									return;
								}catch(e){
									console.warn('Failed to start XR session:', e);
								}
							}
						}catch(e){
							console.warn('Error checking XR support:', e);
						}
					}
					// If we reach here, either WebXR wasn't available or failed â€” user is in fullscreen now.
					try{
						if(!document.fullscreenElement){
							alert('Entered fullscreen. If your VR device supports WebXR, open the page in a VR-capable browser to enter immersive VR.');
						}
					}catch(e){}
				}
				vrButton.addEventListener('click', enterVR);
			})();
		</script>
		<noscript>
			<p><b>Please enable Javascript!</b></p>
		</noscript>
	<!-- -----------8<----------- cut here -----------8<----------- --> 
	</body>
</html>
